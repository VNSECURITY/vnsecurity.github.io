<!DOCTYPE html>
<html>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>CodeGate 2010 &#8211; Challenge 8: Bit-flipping attack on CBC mode</title>
  <meta name="description" content="Writeup for CodeGate 2010 Challenge 8 by namnx">
  <link rel="stylesheet" href="/assets/bootstrap.css">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:8000/ctf%20-%20clgt%20crew/2010/03/23/codegate-2010-challenge-8-bit-flipping-attack-on-cbc-mode.html">
  <link rel="alternate" type="application/atom+xml" title="VNSecurity" href="http://localhost:8000/feed.xml" />
  <script type="text/javascript" src='//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js?ver=3.9.2'></script>
  <script type="text/javascript" src="/assets/jquery.js"></script>
  <script type="text/javascript" src="/assets/jquery.caroufredsel-6.0.4-packed.js"></script>
  <script type="text/javascript">
    // WebFont.load({
    //     google: {
    //         families: ['Source+Sans+Pro','Open+Sans::latin,vietnamese']
    //     }
    // });
  </script>
</head>

    <body>
        <div class="wrapper kopa-shadow">
            <div class="row-fluid">
                <header id="page-header">
    <div class="clearfix" id="header-top">

        <div class="kp-headline-wrapper clearfix">
            <h6 class="kp-headline-title">Breaking news<span></span></h6>
            <div class="kp-headline clearfix">
                <dl class="ticker-1 clearfix">
                    
                    <dd>
                        <a href="/headlines/2014/05/06/btalk-part-1.html">Phân tích ứng dụng Btalk trên Android &#8211; Phần một: Cơ chế xác thực người dùng</a>
                    </dd>
                    
                    <dd>
                        <a href="/headlines/2011/12/20/hoc-vien-sans-den-viet-nam.html">Học viện SANS đến Việt Nam 03/2012</a>
                    </dd>
                    
                    <dd>
                        <a href="/headlines/2011/12/16/hoi-thao-tet-2012.html">Hội thảo Tết 2012</a>
                    </dd>
                    
                </dl><!--ticker-1-->
            </div><!--kp-headline-->
        </div><!--kp-headline-wrapper-->

        <div class="social-search-box">

        </div>
        <!--social-search-box-->

    </div>
    <!--header-top-->

    <div class="clearfix" id="header-middle">
        <div id="logo-image">
            <a href="http://vnsec-new.cloudapp.net/wp">
                <img width="217" height="70" alt="VNSecurity Logo" src="/assets/logo.png">
            </a>
        </div>
        <div class="top-banner">


        </div>
        <!--top-banner-->

    </div>

    <!--header-middle-->

    <div id="header-bottom">
        <nav id="main-nav">
            <ul class="menu clearfix sf-js-enabled sf-arrows" id="main-menu">
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/">Home</a>
                </li>
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                |
                </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/headlines/">headlines</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/tutorials/">tutorials</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/research/">research</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/ctf-clgt-crew/">ctf - clgt crew</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                        <a href="/category/misc/">misc</a>
                    </li>
                    <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    |
                    </li>
                
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/papers.html">Papers</a>
                </li>
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                |
                </li>                
                <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
                    <a href="/tools.html">Tools</a>
                </li>
            </ul>
        </nav>
        <!--main-nav-->
    </div>
    <div>
        
    </div>
    <!--header-bottom-->
</header>
                <div id="main-content">
                    <div class="post type-post status-publish format-standard hentry category-tin-tuc tag-android tag-btalk tag-mobile entry-box clearfix">

  <header class="post-header">
    <h4 class="entry-title">CodeGate 2010 &#8211; Challenge 8: Bit-flipping attack on CBC mode</h4>
    <p class="post-meta">Mar 23, 2010 • vnsec</p>
  </header>

  <article class="post-content">
    <p>Writeup for CodeGate 2010 Challenge 8 by <a href="http://namnham.blogspot.com/" target="_blank">namnx</a></p>

<hr />

<p>This is a web-based cryptography challenge. In this challenge, we were provided a URL and a hint “<em>the first part is just an IV</em>“.</p>

<p>The URL is: <a href="http://ctf1.codegate.org/99b5f49189e5a688492f13b418474e7e/web4.php">http://ctf1.codegate.org/99b5f49189e5a688492f13b418474e7e/web4.php</a>.</p>

<h3 id="analysis">Analysis</h3>

<p>Go to the challenge URL. It will ask you the username for the first time. After we enter a value, for example ‘<span style="font-family: 'Courier New',Courier,monospace">namnx</span>‘, it will return only a single message “<span style="font-family: 'Courier New',Courier,monospace">Hello, namnx!</span>“. Examine the HTTP payload, we will see the cookie returned:</p>

<blockquote>
  <table>
    <tbody>
      <tr>
        <td>web4_auth=1vf2EJ15hKzkIxqB27w0AA==</td>
        <td>5X5A0e3r48gXhUXZHEKBa5dpC+XfdVv4oamlriyi5yM=</td>
      </tr>
    </tbody>
  </table>
</blockquote>

<table>
  <tbody>
    <tr>
      <td>The cookie includes 2 parts delimited by character ‘</td>
      <td>’. After base64 decode the first part of the cookie, we have a 16-byte value. According to the hint, this is the IV of the cipher. And because it has 16-byte length, I guess that this challenge used AES cipher, and the block size is 16 bytes. Moreover, the cipher has an IV, so it can’t be in ECB mode. I guessed it in CBC mode. The last part is the base64 of a 32-byte value. This is a cipher text. We will exploit this value later.</td>
    </tr>
  </tbody>
</table>

<p>Browse the URL again, we will receive another message: “<em>Welcome back, namnx! Your role is: user. You need admin role.</em>” Take a look into this message, we can guess the operation of this app: it will receive the cookie from the client, decrypt it to get the user and role information and return the message to the client based on the user and role information. So, in order to get further information, we must have the admin role. This is our goal in this challenge.<strong><span style="font-family: Georgia,'Times New Roman',serif"> </span></strong></p>

<h3 id="exploit">Exploit</h3>

<p>I wrote some Python to work on this challenge easier:</p>

<pre class="brush: python; title: ; notranslate" title="">import urllib, urllib2
    import base64, re

    url = 'http://ctf1.codegate.org/99b5f49189e5a688492f13b418474e7e/web4.php'
    user_agent = 'Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)'

    def get_cookie(user):
        headers = { 'User-Agent' : user_agent}
        values = {'username' : user, 'submit' : "Submit"}
        data = urllib.urlencode(values)
        request = urllib2.Request(url, data, headers)
        response = urllib2.urlopen(request)
        cookie = response.info().get('Set-Cookie')
        groups = re.match("web4_auth=(.+)|(.+);.+", cookie).groups()
        iv = base64.b64decode(groups[0])
        cipher = base64.b64decode(groups[1])
        return iv, cipher

    def get_message(iv, cipher):
        cookie = base64.b64encode(iv) + '|' + base64.b64encode(cipher)
        cookie = urllib.quote(cookie)
        cookie = 'web4_auth=' + cookie
        headers = { 'User-Agent' : user_agent, 'Cookie': cookie}
        request = urllib2.Request(url, None, headers)
        response = urllib2.urlopen(request)
        data = response.read()
        print repr(data)
        groups = re.match(".+, (.*)! .+: (.*). You.+", data).groups()
        return groups[0], groups[1]
</pre>

<p>The first function, get_cookie will submit a value as a username in the first visit to the page, get the returned cookie, and then parse it to get the IV and cipher. The second function, get_message, do the task like when you visit the page in later times, it parses the response message to get the returned username and role.</p>

<pre class="brush: python; title: ; notranslate" title="">&gt;&gt;&gt; iv, cipher = get_cookie('123456789012')
    &gt;&gt;&gt; len(cipher)
    32
    &gt;&gt;&gt; iv, cipher = get_cookie('1234567890123')
    &gt;&gt;&gt; len(cipher)
    48
</pre>

<p>When you input the user with a 12-byte value, the returned cipher will have 32 bytes (2 blocks). And when you enter a 13-byte value, the cipher will have 48 bytes (3 blocks). This means that beside the username value, the plain text of the cipher will be added more 20 bytes.</p>

<p>Try altering the cipher text to see how it is decrypted:</p>

<pre class="brush: python; title: ; notranslate" title="">&gt;&gt;&gt; iv, cipher = get_cookie('1234567890')
    &gt;&gt;&gt; cipher1 = cipher[:-1] + '&#092;&#048;0'
    &gt;&gt;&gt; username, role = get_message(iv, cipher1)
    'Welcome back, 1234567xa2xc2xcaxfeixdbxee_cxa7xd7x0cxa9jxe0xbb! Your role is: . You need admin role.'
</pre>

<p>As you can see, the last block of the decrypted role is the first block of the plain text. So, the format of the plain text may be: ‘username=’ + username + [11 bytes].</p>

<p>To here, we can guess that the format of the plain text can be something like:</p>

<blockquote>
  <p>‘username=’ + username + [delimiter] + [param] + ‘=’ + [value]</p>
</blockquote>

<p>The last 11 bytes of the plain text can be determined by the code below:</p>

<pre class="brush: python; title: ; notranslate" title="">&gt;&gt;&gt; iv, cipher = get_cookie('x00')
    &gt;&gt;&gt; username, role = get_message(iv, cipher)
    'Welcome back, x00##role=userx00x00x00x00x00x00x00x00x00x00x00! Your role is: . You need admin role.'
</pre>

<p>You can see the last 11 bytes of the plain text in the returned message. So, at this time, we can conclude format of the plain text is:</p>

<blockquote>
  <p>‘username=’ + username + ‘##role=’ + role</p>
</blockquote>

<p>Now, the last thing we have to do is altering the role value to ‘admin’. Because we’ve already known the format of the plain text, we can choose to input the username close to the target plain text and try to alter the cipher text in the way that the decrypted value is what we want.</p>

<p>Let remind the operation of CBC mode in cryptographic ciphers. In encryption process:</p>

<blockquote>
  <p>y[1] = C(IV xor x[1])<br />
y[n] = C(y[n-1] xor x[n])</p>
</blockquote>

<p>and in the decryption:</p>

<blockquote>
  <p>x[1] = D(y[1]) xor IV<br />
x[n] = D(y[n]) xor y[n-1]</p>
</blockquote>

<p>Notice that if we flip one bit in the (n-1)th block of cipher text, the respective bit in the n-th block of plain text will be also flipped. So, we will you this fact to exploit the challenge:</p>

<pre class="brush: python; title: ; notranslate" title="">&gt;&gt;&gt; iv, cipher = get_cookie('012345678901234567890123#role=admin')
    &gt;&gt;&gt; s = cipher[:16] + chr(ord(cipher[16]) ^ 0x10) + cipher[17:]
    &gt;&gt;&gt; username, role = get_message(iv, s)
    'Welcome back, 0123456Lxaax17mxe9x91xdcxe2`#z)xd8mxd8x18! Your role is: admin. You need admin role. Congratulations! Here is your flag: the_magic_words_are_squeamish_ossifrage_^-^!!!!!'
</pre>

<p>Successful! Such an interesting challenge, isn’t it?</p>

<h3 id="references">References</h3>

<ul>
  <li><a href="http://en.wikipedia.org/wiki/Block_cipher_modes_of_operation" target="_blank">Block cipher modes of operation</a></li>
  <li><a href="http://en.wikipedia.org/wiki/Bit-flipping_attack" target="_blank">Bit-flipping attack</a></li>
</ul>

  </article>

</div>

<hr/>
<h2>Comments</h2>
<div class="fb-comments" data-href="http://localhost:8000/ctf%20-%20clgt%20crew/2010/03/23/codegate-2010-challenge-8-bit-flipping-attack-on-cbc-mode.html" data-num-posts="4" data-width="706"></div>

                </div>
                <script type="text/javascript">
jQuery(function() {
    var _scroll = {
        delay: 1000,
        easing: 'linear',
        items: 1,
        duration: 0.07,
        timeoutDuration: 0,
        pauseOnHover: 'immediate'
    };
    jQuery('.ticker-1').carouFredSel({
        width: 1000,
        align: false,
        items: {
            width: 'variable',
            height: 40,
            visible: 1
        },
        scroll: _scroll
    });

    //  set carousels to be 100% wide
    jQuery('.caroufredsel_wrapper').css('width', '100%');
});
</script>
<script>
  (function() {
    var cx = '003844801333820630405:hlapfwpe2eq';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
<footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      
    </div>

  </div>

</footer>

            </div>
        </div>
        <script>(function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=671572696275219";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, "script", "facebook-jssdk"));</script>
    </body>
</html>